<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MainStoreCategoryDao">

<!-- store 전체 행수 -->
<select id="getTotalAllCountPage" resultType="integer">
	select count(*) as cnt
	from store s, store_avail sa
	where s.s_id=sa.s_id and sa.sa_ck='승인'
</select>

<!-- store 조건 포함 행수 -->
<select id="getLimitTotalCountPage" parameterType="mainStoreCategoryVO" resultType="integer">
	select count(*) as cnt
	from (select s.s_id, cmm.catemm_name, cm.catem_name
		  from store s, store_avail sa, cate_sub cs, cate_mid cmm, cate_main cm, goods g
		  where s.s_id=sa.s_id and sa.sa_ck='승인'
			and g.s_id=s.s_id
			and g.cates_code=cs.cates_code 
			and cs.catemm_code=cmm.catemm_code 
			and cmm.catem_code=cm.catem_code
		<if test="catemm_name != null">
			and cm.catem_name=#{catem_name} and cmm.catemm_name=#{catemm_name}
		</if>  
		<if test="catemm_name == null">
			and cm.catem_name=#{catem_name}
		</if>  
		  group by s.s_id, cmm.catemm_name, cm.catem_name)
</select>

<!-- store 테이블 호출 -->
<select id="getStoreAllList" parameterType="mainStoreCategoryVO" resultType="mainStoreCategoryVO" >
	select *
	from ( select t.*, rownum as rnum
		   from ( select s_name, s_id, s_spname, s_text, avgRvStar, countRvCode
				  from ( SELECT s.s_name, s.s_id, s.s_spname, s.s_text, COALESCE(AVG(r.rv_star), 0) AS avgRvStar, COALESCE(COUNT(r.rv_code), 0) AS countRvCode, cmm.catemm_name, cm.catem_name
						 FROM store s
							  LEFT JOIN orderinfo oi ON s.S_ID = oi.S_ID
							  LEFT JOIN final_order fo ON oi.O_CODE = fo.O_CODE
							  LEFT JOIN pay p ON fo.FO_CODE = p.FO_CODE
							  LEFT JOIN review r ON p.P_CODE = r.P_CODE
							  LEFT JOIN goods g ON s.S_ID = g.S_ID
							  LEFT JOIN cate_sub cs ON g.cates_code=cs.cates_code 
							  LEFT JOIN cate_mid cmm ON cs.catemm_code=cmm.catemm_code
							  LEFT JOIN cate_main cm ON cmm.catem_code=cm.catem_code
				<if test="catem_name != null and catemm_name != null">
						 WHERE cm.catem_name=#{catem_name} and cmm.catemm_name=#{catemm_name}
				</if>  
				<if test="catem_name != null and catemm_name == null">
						 WHERE cm.catem_name=#{catem_name}
				</if>  
						 GROUP BY s.S_NAME, s.S_ID, s.s_spname, s.s_text, cmm.catemm_name, cm.catem_name 
						) 
				  GROUP BY S_NAME, S_ID, s_spname, s_text, avgRvStar, countRvCode 
				<if test="orderBy == 2">
				  ORDER BY avgRvStar desc 
				</if>
				<if test="orderBy == 3">
				  ORDER BY countRvCode desc 
				</if>
				 ) t
		  )
<![CDATA[
	where rnum>=#{firstNum} and rnum<=#{endNum}
]]>
</select>

</mapper>